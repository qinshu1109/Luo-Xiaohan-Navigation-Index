# 飞书MCP Token优化策略

## 🚨 问题分析

### Token消耗现状
- **单次调用消耗**: `get_feishu_document_blocks` 60K Tokens
- **主要原因**: 全文档结构加载
- **影响范围**: 导航索引管理、文档操作
- **紧急程度**: 高（影响系统可用性）

## 🎯 解决方案矩阵

### 方案A：工具瘦身（技术优化）
```bash
# 升级到v0.15+版本
npm install feishu-mcp@latest

# 关键配置参数
--tool-set core           # 仅加载核心工具
--nav-lazy true          # 懒加载导航
--nav-top-k 30           # 限制导航条目数
--nav-max-depth 2        # 限制导航深度
```

**效果**: Token消耗从60K降至<10K

### 方案B：AI端规则（使用优化）
- **摘要优先**: 优先使用摘要信息
- **结构化管理**: 分层次管理文档
- **批量操作**: 使用`batch_create_feishu_blocks`
- **精确定位**: Playwright + API结合

### 方案C：Git仓库替代（架构优化）
- **导航索引**: 存储在Git仓库
- **版本控制**: 自动追踪变更
- **访问方式**: GitHub PAT认证
- **Token消耗**: 接近0

## 🚀 推荐实施方案

### A+B组合方案（当前推荐）
1. **立即实施工具瘦身**
   ```bash
   feishu-mcp --tool-set core --nav-lazy true --nav-top-k 30 --nav-max-depth 2
   ```

2. **配置AI端规则**
   - 避免调用`get_feishu_document_blocks`
   - 优先使用精确API操作
   - 实施批量操作策略

3. **建立监控机制**
   - Token使用量监控
   - 性能指标追踪
   - 用户体验评估

### Git仓库方案（长期方案）
1. **创建导航仓库**: ✅ 已完成
2. **迁移导航数据**: 进行中
3. **更新访问逻辑**: 待实施
4. **废弃飞书导航**: 最终目标

## 📊 效果对比

| 方案 | Token消耗 | 实施难度 | 维护成本 | 推荐指数 |
|------|-----------|----------|----------|----------|
| 原始方案 | 60K | - | 高 | ❌ |
| A方案 | <10K | 低 | 中 | ⭐⭐⭐ |
| B方案 | 变动 | 中 | 低 | ⭐⭐⭐ |
| C方案 | ~0 | 高 | 低 | ⭐⭐⭐⭐⭐ |
| A+B组合 | <5K | 中 | 中 | ⭐⭐⭐⭐ |

## 🔧 实施步骤

### 第一阶段：紧急优化（1-2天）
- [x] 升级飞书MCP到v0.15+
- [x] 配置工具瘦身参数
- [x] 实施AI端使用规则
- [x] 建立Git导航仓库

### 第二阶段：深度优化（1周）
- [ ] 完善Git导航结构
- [ ] 迁移核心导航数据
- [ ] 优化工作流程
- [ ] 建立监控体系

### 第三阶段：完全替代（2周）
- [ ] 完成导航数据迁移
- [ ] 更新所有访问逻辑
- [ ] 性能测试验证
- [ ] 废弃飞书导航依赖

## 📈 监控指标

### 关键指标
- **Token使用量**: 目标<5K/次
- **响应时间**: <2秒
- **成功率**: >99%
- **用户满意度**: >90%

### 监控工具
- Token使用统计
- 性能监控面板
- 错误日志分析
- 用户反馈收集

## 🔗 相关资源
- [飞书MCP配置](../mcp-tools/feishu-mcp.md)
- [Git导航仓库](https://github.com/qinshu1109/Luo-Xiaohan-Navigation-Index)
- [Playwright集成指南](../dev-tools/playwright-integration.md)
- [AI工具优化策略](./ai-tools.md)

---
*最后更新: 2025-01-11*
*状态: A+B方案实施中，Git方案准备中*
